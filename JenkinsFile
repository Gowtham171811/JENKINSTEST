pipeline {
   agent any 

   environment {
      DOTNET_CLI_HOME = "D:\\JENKINS_TEST_APP" 
      REMOTE_SERVER = "192.168.1.212" 
      REMOTE_PATH = "D:\\iis\\samplesit"
      LOCAL_PUBLISH_PATH = ".\\publish"
   }

   stages {
      stage('Checkout') {
         steps {
            checkout scm
         }
      }

      stage('Build') {
         steps {
            script {
               bat "dotnet restore" 
               bat "dotnet build --configuration Release"
            }
         }
      }

      stage('Test') {
         steps {
            script {
               bat "dotnet test --no-restore --configuration Release"
            }
         }
      }

      stage('Publish') {
         steps {
            script {
               bat "dotnet publish --no-restore --configuration Release --output ${env.LOCAL_PUBLISH_PATH}"
            }
         }
      }

      stage('Deploy') {
         steps {
            script {
               powershell '''
               $sourcePath = "${env.LOCAL_PUBLISH_PATH}"
               $destinationPath = "\\\\${env.REMOTE_SERVER}\\D$\\iis\\samplesit"  # Ensure share permissions

               Write-Host "Source Path: $sourcePath"
               Write-Host "Destination Path: $destinationPath"

               if (!(Test-Path $sourcePath)) {
                   throw "Source path not found: $sourcePath"
               }
               if (!(Test-Path $destinationPath)) {
                   throw "Destination path not found: $destinationPath"
               }

               Copy-Item -Path "$sourcePath\\*" -Destination "$destinationPath" -Recurse -Force
               '''
            }
         }
      }

      stage('Restart IIS') {
         steps {
            script {
               powershell '''
               Invoke-Command -ComputerName ${env.REMOTE_SERVER} -ScriptBlock {
                  iisreset /restart
               }
               '''
            }
         }
      }
   }

   post {
      success {
         echo 'Build, test, and publish successful!'
      }
      failure {
         echo 'Build failed. Please check the logs and errors.'
      }
   }
}
